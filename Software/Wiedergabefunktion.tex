% !TEX root = BA-Bauer.tex

\subsection{Wiedergabefunktion}
Für die Wiedergabe der aufgenommenen DMX-Daten werden zwei Wiedergabemodi benötigt. Die Aufnahmedaten der Standard-, Trigger- und Endlosaufnahme werden für die Wiedergabe gleich behandelt. Die Aufnahmedaten der $Step$-Aufnahme müssen gesondert behandelt werden, da diese keine Zeitinformation enthalten. Für beide Aufnahmemodi muss zunächst die entsprechende Aufnahmedatei ausgewählt werden.

\subsubsection{Auswahl der Aufnahmedatei}
\label{sec:selectfile}
Um dem Benutzer eine Auswahl der Aufnahmedatei zu ermöglichen, muss zunächst die SD-Karte nach vorhandenen Dateien durchsucht werden. Zudem müssen die Namen abgerufen und auf dem LCD-Display ausgegeben werden. Mithilfe der Funktion $f\_findfirst(..)$ kann die SD-Karte an einem bestimmten Dateipfad nach Dateien mit einem bestimmten Muster im Dateinamen durchsucht werden. Alle Aufnahmedateien werden mit der Endung $.dmx$ gespeichert. Das Suchmuster wird mit $*.dmx$ festgelegt und bedeutet, dass jede Datei, deren letzte vier Zeichen $.dmx$ beinhalten, gefunden werden. Der Funktion $f\_findfirst(...)$ wird zudem eine $FILINFO$ Struktur namens $info$ übergeben. Wird eine Datei passend zu dem festgelegten Suchmuster gefunden, so wird unter anderem der vollständige Dateiname in dem Zeichen-Array $info.fname$ gespeichert. Ist das Array leer, wurde keine Datei gefunden. Nachdem die erste Datei gefunden ist, müssen die restlichen auf der SD-Karte befindlichen Dateien gefunden werden. Dafür wird die Funktion $f_findnext(...)$ verwendet. Diese Funktion wird so lange aufgerufen, bis keine weitere Datei gefunden wird. Nach jedem erfolgreichen Aufruf wird der Dateiname in ein multidimensionales Zeichen-Array gespeichert, welches 20 Dateinamen beinhalten kann. Der Inhalt dieses Arrays wird dazu benutzt die Dateinamen auf dem LCD-Display darzustellen. Durch drehen des Encoders wird die Auswahl verändert. Ist eine Auswahl getroffen, wird sie mit dem Bestätigen-Taster bestätigt. Die Auswahl der Aufnahmedatei kann jederzeit durch Betätigen des Zurück-Taster abgebrochen werden.\\
\newline
\textbf{Optimierungsmöglichkeiten}\\
Die Auswahlfunktion ist durch die Größe des multidimensionalen Zeichen-Arrays auf die Anzeige von maximal 20 Dateinamen begrenzt. Für die Weiterentwicklung der Software ist es sinnvoll eine Lösung zu finden, bei der die Anzahl der maximal anzuzeigenden Dateien nicht begrenzt ist.

%Im Gegensatz zu den mehreren Aufnamefunktionen gibt es für die Wiedergabe der DMX-Daten nur eine Wiedergabefunktion. Aus den auf der SD-Karte während der Aufnahme gespeicherten Informationen in der $.nfo$-Datei kann bestimmt werden, wie die gespeicherten Daten wiedergegeben werden müssen. Zunächst startet die Funktion mit der Auswahl der wiederzugebenen Aufnahmedatei. Dafür wird die SD-Karte nach Dateien durchsucht die eine $.dmx$ Dateiendung besitzen. Die Dateinamen werden dann auf dem Display angezeigt und können durch das Drehen des Encoders ausgewählt werden. Mit dem Bestätigungs-Taster wird die Auswahl festgelegt und das erste Datenbyte gelesen. Auf dem Display erscheint eine Abfrage ob die Wiedergabe gestartet werden soll. Wird ein weiteres Mal der Bestätigungstaster betätigt, startet die Wiedergabe. Sie kann mit einer Betätigung des Zurück-Tasters gestoppt werden.

\subsubsection{Wiedergabe einer kontinuierlichen Aufnahme}
Nachdem eine Aufnahmedatei erfolgreich ausgewählt ist, werden die zugehörige Info-Datei geöffnet und die Daten gelesen. Ist die darin befindliche Aufnahmedauer größer als null, handelt es sich um eine kontinuierliche Aufnahme. Für die Wiedergabe wird der Standardmodus verwendet. Ein Flussdiagramm der Funktion befindet sich im Anhang \ref{fluss:playconti}. Als erstes wird ein Millisekunden Timer gestartet, woraufhin vier Bytes aus der Aufnahmedatei gelesen werden. Der Inhalt der ersten vier Bytes ist der bei der Aufnahme registrierte Zeitpunkt, an dem das DMX-Datenpaket vollständig empfangen ist, wie in Kapitel \ref{sec:save_data} erläutert ist. Bei der Wiedergabe fungiert diese Zeit als Startzeitpunkt des jeweiligen Datenpaketes. Anschließend werden einzelne Bytes aus der Datei gelesen, bis entweder das Ende der Datei erreicht ist, die maximale Anzahl DMX-Kanälen eines Datenpaketes erreicht ist oder das NPC-Zeichen erkannt wird. Ist das Ende der Datei erreicht, wird mithilfe der Funktion $f\_lseek(...)$ zum Beginn der Datei zurückgekehrt und der Zähler des gestarteten Timers auf 0 zurückgesetzt. Ist das NPC-Zeichen erkannt oder die maximale Anzahl an Bytes empfangen, so wird die am Anfang gelesene Startzeit des Datenpaketes mit dem Zähler des Timers verglichen, bis der Zähler den gleichen oder einen höheren Wert als die Startzeit besitzt. Erst danach wird das DMX-Datenpaket gesendet und die Funktion startet erneut mit dem Lesen der Startzeit des nächsten Datenpaketes. Die Wiedergabe kann durch die Betätigung des Zurück-Tasters beendet werden. Die Abfrage der Betätigung erfolgt jeweils vor dem Lesen der Startzeit.
\input{Software/DMX-Out}